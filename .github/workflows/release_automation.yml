name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'jellyfin.ruleset'
      - '.gitignore'
      - '.editorconfig'
      - 'LICENSE'
      - 'logo.png'

jobs:
  build-and-release:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      # Auto increment version (1.0.0.1 -> 1.0.0.2)
      - name: Increment Version
        shell: bash
        run: |
          set -euo pipefail

          CURRENT_VERSION=$(jq -r '.[0].versions[0].version' manifest.json)
          echo "Current Version: $CURRENT_VERSION"

          IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$CURRENT_VERSION"
          BUILD=$((BUILD + 1))

          NEW_VERSION="$MAJOR.$MINOR.$PATCH.$BUILD"
          echo "New Version: $NEW_VERSION"

          jq --arg ver "$NEW_VERSION" \
             '.[0].versions[0].version = $ver' \
             manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json

          echo "VERSION=$NEW_VERSION" >> "$GITHUB_ENV"

      - name: Commit Version Bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto bump version to v${{ env.VERSION }} [skip ci]"
          file_pattern: manifest.json

      - name: Read Remaining Manifest Data
        shell: bash
        run: |
          set -euo pipefail
          TARGET_ABI=$(jq -r '.[0].versions[0].targetAbi' manifest.json)
          PLUGIN_GUID=$(jq -r '.[0].guid' manifest.json)

          echo "TARGET_ABI=$TARGET_ABI" >> "$GITHUB_ENV"
          echo "PLUGIN_GUID=$PLUGIN_GUID" >> "$GITHUB_ENV"

      - name: Build and Zip
        shell: bash
        run: |
          set -euo pipefail

          dotnet build Jellyfin.Plugin.Seasonals/Jellyfin.Plugin.Seasonals.csproj \
            --configuration Release \
            --output bin/Publish \
            /p:Version="${{ env.VERSION }}" \
            /p:AssemblyVersion="${{ env.VERSION }}"

          cd bin/Publish
          zip -r Jellyfin.Plugin.Seasonals.zip *
          cd ../..

          HASH=$(md5sum bin/Publish/Jellyfin.Plugin.Seasonals.zip | awk '{ print $1 }')
          TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "ZIP_HASH=$HASH" >> "$GITHUB_ENV"
          echo "BUILD_TIME=$TIME" >> "$GITHUB_ENV"
          echo "ZIP_PATH=bin/Publish/Jellyfin.Plugin.Seasonals.zip" >> "$GITHUB_ENV"

      # Generate changelog from merged PR (title + body). Fallback: last 25 commit subjects.
      - name: Generate Changelog
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          SHA="${GITHUB_SHA}"

          PR_JSON="$(gh api -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/commits/$SHA/pulls" || echo '[]')"

          PR_NUMBER="$(echo "$PR_JSON" | jq -r '.[0].number // empty')"

          if [[ -n "$PR_NUMBER" ]]; then
            PR_DETAIL="$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$OWNER/$REPO/pulls/$PR_NUMBER")"

            TITLE="$(echo "$PR_DETAIL" | jq -r '.title // ""')"
            BODY="$(echo "$PR_DETAIL" | jq -r '.body // ""')"

            # Build changelog safely (no literal blank lines inside quotes)
            CHANGELOG="### $TITLE"
            if [[ -n "${BODY// }" ]]; then
              CHANGELOG="${CHANGELOG}"$'\n\n'"${BODY}"
            fi
          else
            CHANGELOG="$(git log -n 25 --pretty=format:'- %s (%h)' --no-merges)"
            [[ -n "${CHANGELOG// }" ]] || CHANGELOG="- Maintenance release"
          fi

          echo "CHANGELOG<<EOF" >> "$GITHUB_ENV"
          printf "%s\n" "$CHANGELOG" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Update manifest.json with Release Info
        shell: bash
        run: |
          set -euo pipefail

          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          VERSION="${{ env.VERSION }}"
          DOWNLOAD_URL="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/v$VERSION/Jellyfin.Plugin.Seasonals.zip"

          TARGET_ABI=$(jq -r '.[0].versions[0].targetAbi' manifest.json)

          jq --arg ver "$VERSION" \
             --arg hash "${{ env.ZIP_HASH }}" \
             --arg time "${{ env.BUILD_TIME }}" \
             --arg url "$DOWNLOAD_URL" \
             --arg changelog "${{ env.CHANGELOG }}" \
             --arg abi "$TARGET_ABI" \
             '
             .[0].versions = [{
                "version": $ver,
                "changelog": $changelog,
                "targetAbi": $abi,
                "sourceUrl": $url,
                "checksum": $hash,
                "timestamp": $time
             }] + .[0].versions
             ' manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json

      - name: Commit manifest.json Update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update manifest.json for release v${{ env.VERSION }} [skip ci]"
          file_pattern: manifest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "v${{ env.VERSION }}"
          body: ${{ env.CHANGELOG }}
          files: ${{ env.ZIP_PATH }}
          draft: false
          prerelease: false
          generate_release_notes: false
